<!DOCTYPE html>
<html>
<head>
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen"></link>
  <link href="css/bootstrap-responsive.min.css" rel="stylesheet" media="screen"></link>
  <link href="css/slider.css" rel="stylesheet" media="screen"></link>
  <style>
    .slider {float: right;}
  </style>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/underscore-min.js"></script>
  <script src="/js/bootstrap-slider.js"></script>
  <script src="/js/soundmanager2.js"></script>
  <script>
    var INITIAL_VALUE = 0, EPS = 0.001;
    var sliderElements = [];
    var currentSound;

    function roundDec(value) {
      return Math.round(value*100)/100;
    }

    var submit = function() {
      var data = {parameters: {}};
      _(sliderElements).each(function(elem) {
        var val = elem.data('slider').getValue();
        var initial = elem.data('initial');
        if (Math.abs(val - initial) < EPS) return;

        var name;
        if (name = elem.data('parameterName')) {
          data.parameters[name] = roundDec(val);
        }
        else if (name = elem.data('name')) {
          data[name] = roundDec(val);
        }

      });

      var dataStr = JSON.stringify(data);
      console.log(dataStr);

      soundManager.createSound({
        id: "render" + Math.abs(Math.random()),
        url: "/render.wav?" + dataStr,
        autoLoad: true,
        onload: function() {
          if (currentSound) {
            currentSound.stop();
            currentSound.destruct();
          }
          currentSound = this;
          currentSound.play();
        },
        onfinish: function() {
          console.log("Destroying sound");
          this.destruct();
        }
      });
    }

    submit = _.throttle(submit, 300);

    var addSliderElement = function(data) {
      var name = data.name || data.parameterName;
      var input = $("<input type='text'>");
      $("<div class='well'></div>").text(data.name || data.parameterName)
        .append(input).appendTo('.sliders');

      data.initial = data.initial || data.val || INITIAL_VALUE;

      input.data(data).slider({
        min: data.min || 0, max: data.max || 1,
        step: data.step || 0.01, value: data.initial,
        formater/*sic*/: function(value) {return name+": "+roundDec(value);}
      }).on('slide', submit);

      sliderElements.push(input);
    }

    soundManager.setup({
      url: '/swf',
      preferFlash: false,
      onready: function() {
        addSliderElement({name: 'midiPitch', min: 20, max: 100, step: 1, val: 60});
        addSliderElement({name: 'midiVelocity', min: 1, max: 127, step: 1, val: 120});

        $.getJSON('/list.json', function(data) {
          _(data.parameters).map(function(value, name) {
            console.log(name, value);
            addSliderElement({parameterName: name, val: value})
          });
          submit();
        });
      },
      ontimeout: function() {
        alert("SoundManager could not start. If Flash is blocked, please allow it.");
      }
    })
  </script>
</head>
<body>
  <div class="container">
    <h1>Jucebouncer Demo</h1>

    <div class="row-fluid">
      <div class="span8 sliders">
      </div>
      <div class="span4 render">
      </div>
    </div>
  </div>
</body>
</html>